<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athletics Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCbPN3RlAijcdtwb1Itj71nTYvm4kwN9tk",
            authDomain: "atheltics-f30e7.firebaseapp.com",
            databaseURL: "https://atheltics-f30e7-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "atheltics-f30e7",
            storageBucket: "atheltics-f30e7.appspot.com",
            messagingSenderId: "185026923383",
            appId: "1:185026923383:web:ef2fbe44977ada3aa96f72",
            measurementId: "G-8STC1X6VWM"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const timerRef = ref(db, "timer");
        const lapRef = ref(db, "laps");
        const triggerLapRef = ref(db, "triggerLap");

        let timerInterval = null;
        let serverStartTime = null;
        let localStartTime = null;
        let isRunning = false;
        let lastSyncTime = 0;

        // Format time (MM:SS:MS)
        function formatTime(time) {
            const minutes = Math.floor(time / 60000);
            const seconds = Math.floor((time % 60000) / 1000);
            const milliseconds = Math.floor((time % 1000) / 10);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}.${milliseconds < 10 ? '0' : ''}${milliseconds}`;
        }

        // Update Timer Display
        function updateTimer() {
            if (!isRunning || !serverStartTime) return;
            
            // Calculate time based on server start time and local clock
            const now = Date.now();
            const elapsed = now - localStartTime + (serverStartTime - lastSyncTime);
            document.getElementById("timer").innerText = formatTime(elapsed);
        }

        // Start Timer
        function startRace() {
            if (!isRunning) {
                // Use server timestamp for synchronization
                set(timerRef, { 
                    startTime: serverTimestamp(), 
                    running: true 
                }).then(() => {
                    console.log("Race started");
                });
            }
        }

        // Stop Timer
        function stopRace() {
            if (isRunning) {
                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;

                const displayedTime = document.getElementById("timer").innerText;

                set(timerRef, { 
                    running: false, 
                    finalTime: displayedTime,
                    lastUpdate: serverTimestamp()
                }).then(() => console.log("Timer stopped at:", displayedTime))
                  .catch((error) => console.error("Error stopping timer:", error));
            }
        }

        // Record Lap
        function recordLap() {
            if (!isRunning) return;
            const displayedTime = document.getElementById("timer").innerText;

            push(lapRef, {
                time: displayedTime,
                timestamp: serverTimestamp()
            }).then(() => console.log("Lap recorded:", displayedTime))
              .catch((error) => console.error("Error recording lap:", error));
        }

        // Reset Laps
        function resetLaps() {
            remove(lapRef);
        }

        // Clear All Data
        function clearStoredData() {
            remove(timerRef);
            remove(lapRef);
            document.getElementById("timer").innerText = "00:00.00";
            isRunning = false;
            clearInterval(timerInterval);
        }

        // Update Lap List in UI
        function updateLapList(laps) {
            const lapList = document.getElementById("lapsList");
            lapList.innerHTML = !laps ? '<li class="text-white/70">No laps recorded yet</li>' : '';

            if (laps) {
                // Convert laps object to array and sort by timestamp
                const lapsArray = Object.entries(laps).map(([key, value]) => ({
                    id: key,
                    ...value
                })).sort((a, b) => a.timestamp - b.timestamp);
                
                // Display last 10 laps
                lapsArray.slice(-10).forEach((lap, index) => {
                    const li = document.createElement("li");
                    li.className = "text-white";
                    li.innerText = `Lap ${index + 1}: ${lap.time}`;
                    lapList.appendChild(li);
                });
            }
        }

        // Listen for Timer Changes in Firebase
        onValue(timerRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (data.running && data.startTime) {
                    // Use server time for synchronization
                    serverStartTime = data.startTime;
                    localStartTime = Date.now();
                    lastSyncTime = data.startTime;
                    
                    if (!isRunning) {
                        isRunning = true;
                        clearInterval(timerInterval);
                        timerInterval = setInterval(updateTimer, 10);
                    }
                } else {
                    // Timer stopped
                    clearInterval(timerInterval);
                    isRunning = false;
                    if (data.finalTime) {
                        document.getElementById("timer").innerText = data.finalTime;
                    }
                }
            } else {
                // No timer data
                document.getElementById("timer").innerText = "00:00.00";
                isRunning = false;
                clearInterval(timerInterval);
            }
        });

        // Listen for Lap Changes in Firebase
        onValue(lapRef, (snapshot) => {
            updateLapList(snapshot.val());
        });

        // Attach Event Listeners
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("startButton").onclick = startRace;
            document.getElementById("stopButton").onclick = stopRace;
            document.getElementById("recordLapButton").onclick = recordLap;
            document.getElementById("resetLapsButton").onclick = resetLaps;
            document.getElementById("clearDataButton").onclick = clearStoredData;
        });

        // Listen for ESP8266 Lap Trigger
        onValue(triggerLapRef, (snapshot) => {
            const data = snapshot.val();
            if (data === true) {
                recordLap();
                set(triggerLapRef, false);
            }
        });
    </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center p-4">
    <div class="glass-card p-8 rounded-3xl shadow-2xl max-w-md w-full">
        <h1 class="text-4xl font-bold text-white mb-6 text-center">Athletics Timer</h1>
        <div id="timer" class="text-6xl font-mono text-white mb-8 text-center">00:00.00</div>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <button id="startButton" class="bg-green-500 text-white py-3 px-6 rounded-xl">Start Race</button>
            <button id="stopButton" class="bg-red-500 text-white py-3 px-6 rounded-xl">Stop Race</button>
            <button id="recordLapButton" class="bg-blue-500 text-white py-3 px-6 rounded-xl">Record Lap</button>
            <button id="resetLapsButton" class="bg-purple-500 text-white py-3 px-6 rounded-xl">Reset Laps</button>
            <button id="clearDataButton" class="bg-gray-500 text-white py-3 px-6 rounded-xl">Clear Data</button>
        </div>
        <div class="bg-white/10 p-4 rounded-2xl">
            <h2 class="text-xl text-white font-semibold mb-3">Laps</h2>
            <ul id="lapsList" class="text-white"></ul>
        </div>
    </div>
</body>
</html>
